name: Automated Deploy

on:
  workflow_run:
    workflows:
      - Build Hosts
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ci-ocf-nix-deploy
    steps:
      - uses: actions/checkout@v4

      - name: Setup hosts
        run: |
          HOSTS=$(nix eval .#automatedDeployNodes --apply 'builtins.concatStringsSep " "' --raw)
          echo "HOSTS=$HOSTS" >> $GITHUB_ENV

      - name: Wake up hosts
        run: |
          HOST_MACS=$(nix eval .#automatedDeployNodeMACs --apply 'builtins.concatStringsSep " "' --raw)
          # not using quotes here so that each mac address is a separate argument
          wol $HOST_MACS

      - name: Setup SSH
        run: |
          echo '${{ secrets.COLMENA_APPLY_SSH_KEY }}' > ${{ github.workspace }}/id_ed25519
          chmod 400 id_ed25519

          for host in ${HOSTS}; do
            cat secrets/host-keys/$host.pub | sed "s/^/$host.ocf.berkeley.edu /" >> known_hosts
          done

          echo "
          Identityfile $GITHUB_WORKSPACE/id_ed25519
          UserKnownHostsFile $GITHUB_WORKSPACE/known_hosts
          StrictHostKeyChecking yes
          UpdateHostKeys no
          " >> ${{ github.workspace }}/ssh_config

      - name: Deploy with colmena
        env:
          SSH_CONFIG_FILE: ${{ github.workspace }}/ssh_config
        run: |
          echo "$HOSTS" | tr ' ' '\n' | \
          xargs -P 10 -n 1 -I {} \
          sh -c "
            if nix develop .#deploy -c colmena apply --on {} switch --no-build > {}.log 2>&1; then
              echo '✅ Successfully deployed to {}'
              echo 'SUCCESS:{}' >> results.txt
            else
              echo '❌ Failed to deploy to {}'
              echo 'FAILURE:{}' >> results.txt
            fi
          "

      - name: Display successful logs
        if: always()
        run: |
          grep "SUCCESS:" results.txt | cut -d':' -f2 | while read host; do
            echo "--- $host ---"
            cat "${host}.log"
          done

      - name: Display failed logs
        if: always()
        run: |
          grep "FAILURE:" results.txt | cut -d':' -f2 | while read host; do
            echo "--- $host ---"
            cat "${host}.log"
          done

      - name: Check status
        if: always()
        run: |
          if grep -q "FAILURE:" results.txt; then
            exit 1
          fi

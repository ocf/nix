name: Manually Deploy to Host

on:
  workflow_dispatch:
    inputs:
      hosts:
        description: 'Comma separated hostnames or tags (ex: @desktops) to deploy'
        required: true
        type: string

run-name: Deploy to ${{ inputs.hosts }} from ${{ github.ref_name }} by @${{ github.actor }}

jobs:
  deploy-on-hosts:
    runs-on: ci-ocf-nix-deploy
    steps:
      - name: Checkout 
        uses: actions/checkout@v4

      - name: Setup SSH Private Key
        run: |
          echo '${{ secrets.COLMENA_APPLY_SSH_KEY }}' > ${{ github.workspace }}/id_ed25519
          chmod 400 ${{ github.workspace }}/id_ed25519

      - name: Setup SSH Known Hosts
        run: |
          for keyfile in ${{ github.workspace }}/secrets/host-keys/*.pub; do
            hostname=$(basename "$keyfile" .pub)
            fqdn="$hostname.ocf.berkeley.edu"
            pubkey=$(cat "$keyfile")
            echo "$fqdn $pubkey"
          done > ${{ github.workspace }}/known_hosts

      - name: Setup SSH Config File
        run: |
          echo "
          Identityfile $GITHUB_WORKSPACE/id_ed25519
          UserKnownHostsFile $GITHUB_WORKSPACE/known_hosts
          StrictHostKeyChecking yes
          UpdateHostKeys no
          " >> ${{ github.workspace }}/ssh_config

      - name: Deploy with Colmena
        env:
          SSH_CONFIG_FILE: ${{ github.workspace }}/ssh_config
        run: nix develop .#deploy -c colmena apply --on ${{ inputs.hosts }}
